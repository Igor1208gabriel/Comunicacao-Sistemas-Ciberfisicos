name: Build and Analyze ROS2
on: [push, pull_request]
jobs:
  build-and-analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # üî• CACHE DOCKER AUTOM√ÅTICO (CORRETO!)
      - name: Build DevContainer image
        uses: docker/build-push-action@v6
        with:
          context: .devcontainer
          file: .devcontainer/Dockerfile
          push: false
          tags: ros2-dev:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # üî• CACHE ROS2 + BUILD COM LOGS VIS√çVEIS
      - name: Build ROS2 Workspace
        run: |
          docker run --rm \
          --privileged \
          --network=host \
          --user root \
          -v ${{ github.workspace }}:/project \
          -w /project/ROS2/workspace \
          ros2-dev \
          bash -c "
            source /opt/ros/humble/setup.bash
            
            # ‚úÖ LOGS VIS√çVEIS NA TELA PRINCIPAL
            echo 'üì¶ INSTALLING DEPENDENCIES...'
            rosdep install --from-paths src --ignore-src -r -y || { echo '‚ùå ROSDEP FAILED'; exit 1; }
            
            echo 'üèóÔ∏è  BUILDING ROS2 PACKAGES...'
            colcon build \
              --symlink-install \
              --event-handlers console_direct+ \
              --event-handlers console_cohesion+ \
              || { echo '‚ùå COLCON BUILD FAILED'; exit 1; }
            
            echo '‚úÖ BUILD COMPLETED SUCCESSFULLY!'
          "
      
      # üî• ERROS NA TELA PRINCIPAL (SUM√ÅRIO)
      - name: Show Build Summary
        if: always()
        run: |
          if [ -f ROS2/workspace/install/setup.bash ]; then
            echo "‚úÖ **BUILD SUCCESS** - $(find ROS2/workspace/build -name '*.so' | wc -l) packages built!"
          else
            echo "‚ùå **BUILD FAILED** - Check logs above!"
          fi
      
      - name: SonarQube Scan
        if: success()  # S√≥ roda se build OK
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602
        env:
          SONAR_HOST_URL: https://sonarcloud.io
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}